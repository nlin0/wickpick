<!DOCTYPE html>
<html lang="en">

<head>
  <title>{% block title %}{% endblock %} - Flaskr</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
    rel="stylesheet">
</head>

<body>
  <div class="full-body-container">

    <div class="filters">
      <div class="category-buttons" id="category-filters">
        <!-- buttons added here via javascript -->
      </div>
      <button class="clear-filter-btn" onclick="clearFilters()">Clear Filter</button>
    </div>


    <div class="top-text">
      <div class="logo-header">
        <img class="wickpick-img" src="{{ url_for('static', filename='images/wickpick.gif') }}" />
      </div>
      <div class="input-box" onclick="sendFocus()">
        <img class="search-icon" src="{{ url_for('static', filename='images/mag.png') }}" />
        <input placeholder="search candles" id="filter-text-val" onkeydown="checkEnter(event)">
      </div>
    </div>

    <div class="candle-display">
      <div id="answer-box">

      </div>
    </div>

  </div>


  <script>
    function answerBoxTemplate(name, url, desc, rating, numReviews, img_url) {
      return `
        <div class='candle-item'>
          <div class="candle-child-container">
            <div class="card-front">
              <h3 class='candle-name'><a href="${url}" target="_blank" class="candle-link">${name}</a></h3>
              <div class="candle-img-container">
                <img class="candle-photo" src="${img_url}" alt="${name}">
              </div>
            </div>
            
            <div class="card-back">
              <h3 class='card-back-title'><a href="${url}" target="_blank" class="candle-link">${name}</a></h3>
              <p class='candle-desc'>${desc}</p>
              <p class='candle-rating'>${rating} <img class="rating-star" src="static/images/star.png" alt="stars"> (${numReviews} reviews)</p>
            </div>
          </div>
        </div>`
    }

    // searches when we use enter
    function checkEnter(event) {
      if (event.key === "Enter") {
        filterText();

        document.getElementById("candle-display").scrollIntoView({
          behavior: "smooth"
        });
      }
    }

    function sendFocus() {
      document.getElementById('filter-text-val').focus()
    }

    document.addEventListener('DOMContentLoaded', function () {
      initFilterUI();
    });

    let activeCategory = null;

    const categories = [
      "Fresh & Clean",
      "Sweet & Spicy",
      "Citrus",
      "Floral",
      "Woody",
      "Fruity",
      "Gourmand"
    ];

    const categorySynonyms = {
      "sweet": "Sweet & Spicy",
      "spicy": "Sweet & Spicy",
      "fresh": "Fresh & Clean",
      "clean": "Fresh & Clean"
    };

    function initFilterUI() {
      const filtersDiv = document.querySelector('.filters');
      if (!filtersDiv) return;

      filtersDiv.innerHTML = `
    <div class="buttons">

      <div class="category-buttons" id="category-filters"></div>
      <button class="clear-filter-btn" onclick="clearFilters()">Clear Filters</button>

    </div>
  `;

      createCategoryButtons();
    }

    function createCategoryButtons() {
      const categoryFilters = document.getElementById('category-filters');
      if (!categoryFilters) return;

      categories.forEach(category => {
        const button = document.createElement('button');
        button.innerText = category;
        button.className = 'category-btn';
        button.onclick = function () {
          filterByCategory(category);
        };
        categoryFilters.appendChild(button);
      });
    }

    function filterByCategory(category) {
      if (activeCategory === category) {
        activeCategory = null;
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('active');
        });
      } else {
        activeCategory = category;
        document.querySelectorAll('.category-btn').forEach(btn => {
          if (btn.innerText === category) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      filterText();
    }

    function clearFilters() {
      activeCategory = null;
      document.getElementById('filter-text-val').value = '';
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById("answer-box").innerHTML = "";
      document.getElementById("answer-box").classList.add("hidden");
    }


    function filterText() {
      document.getElementById("answer-box").innerHTML = "";
      let query = document.getElementById("filter-text-val").value;

      const params = new URLSearchParams();
      if (query) {
        params.append('query', query);
      }
      if (activeCategory) {
        params.append('category', activeCategory);
      }

      if (query === "" && !activeCategory) {
        document.getElementById("answer-box").innerHTML = "";
        document.getElementById("answer-box").classList.add("hidden");
        return;
      }

      fetch("/candles?" + params.toString())
        .then((response) => response.json())
        .then((data) => {
          if (data.length === 0) {
            document.getElementById("answer-box").innerHTML = "<p>No candles found.</p>";
            document.getElementById("answer-box").classList.remove("hidden");
            return;
          }

          const uniqueCandles = {};
          data.forEach(row => {
            if (!uniqueCandles[row.name]) {
              uniqueCandles[row.name] = row;
            }
          });

          const uniqueData = Object.values(uniqueCandles);

          uniqueData.forEach(row => {
            let tempDiv = document.createElement("div");
            tempDiv.innerHTML = answerBoxTemplate(
              row.name, row.link, row.description, row.overall_rating, row.overall_reviewcount, row.img_url
            );

            tempDiv.firstElementChild.addEventListener("click", (e) => {
              if (!e.target.closest('a')) {
                tempDiv.firstElementChild.classList.toggle("expanded");
              }
            });

            document.getElementById("answer-box").appendChild(tempDiv);
          });

          document.getElementById("answer-box").classList.remove("hidden");
        });
    }

    // fetch("/episodes?" + new URLSearchParams({ title: document.getElementById("filter-text-val").value }).toString())
    // .then((response) => response.json())
    // .then((data) => data.forEach(row => {

    //     let tempDiv = document.createElement("div")
    //     tempDiv.innerHTML = answerBoxTemplate(row.title, row.descr, row.imdb_rating)
    //     document.getElementById("answer-box").appendChild(tempDiv)
    // }));

  </script>
</body>